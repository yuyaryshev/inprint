"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.handleFile = handleFile;
exports.callEmbeddedFeatures = callEmbeddedFeatures;
exports.doInprint = doInprint;
exports.run = run;
exports.writeFileSyncIfChanged = exports.usageNotice = exports.endPrefix = exports.startPrefix = exports.inprint_prefix = void 0;

var _json = _interopRequireDefault(require("json5"));

var _globby = _interopRequireDefault(require("globby"));

var _fs = require("fs");

var _path = require("path");

var _embeddedFeatures = require("./embeddedFeatures");

var _InprintOptions = require("./InprintOptions");

var _formatTypescript = require("./formatTypescript");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const inprint_prefix = "@" + "INPRINT";
exports.inprint_prefix = inprint_prefix;
const startPrefix = "_START";
exports.startPrefix = startPrefix;
const endPrefix = "_END";
exports.endPrefix = endPrefix;
const usageNotice = `
USAGE:

// ${inprint_prefix}_START {...any_json_params...}
// Generated code will go here
// ${inprint_prefix}_END
`;
exports.usageNotice = usageNotice;

const writeFileSyncIfChanged = (fileName, content) => {
  let current;

  try {
    current = (0, _fs.readFileSync)(fileName, "utf-8");
  } catch (e) {}

  if (current !== content) {
    (0, _fs.writeFileSync)(fileName, content, "utf-8");
    return true;
  }

  return false;
};

exports.writeFileSyncIfChanged = writeFileSyncIfChanged;

function handleFile(filePath, options) {
  const contentStr = (0, _fs.readFileSync)(filePath, "utf-8");
  if (!contentStr.includes(inprint_prefix)) return false;
  const [fileHeader, ...parts0] = contentStr.split(inprint_prefix);
  const parts = [];

  for (let i = 0; i < parts0.length; i += 2) {
    const s = parts0[i];

    if (!s.startsWith(startPrefix)) {
      console.error(`CODE00000001 INPRINT_ERROR No ${inprint_prefix}${startPrefix} in ${filePath}`);
      return false;
    }

    if (!parts0[i + 1].startsWith(endPrefix)) {
      console.error(`CODE00000002 INPRINT_ERROR No ${inprint_prefix}${endPrefix} in ${filePath}`);
    }

    try {
      const [header, ...middleParts] = s.split("\n");
      const lastPart = middleParts.pop();
      const paramsStr = header.substr(startPrefix.length).trim();
      const middle = middleParts.join("\n");
      const tail = lastPart + inprint_prefix + parts0[i + 1];

      const params = _objectSpread({
        content: middle,
        absolutePath: filePath
      }, _json.default.parse(paramsStr));

      parts.push({
        header,
        params,
        middle,
        tail,
        newMiddle: ""
      });
    } catch (e) {
      console.error(`CODE00000003 INPRINT_ERROR ${e.message} in ${filePath}`);
      return false;
    }
  }

  for (let part of parts) {
    try {
      part.newMiddle = (0, _formatTypescript.formatTypescript)(doInprint(part.params, options), options.prettierOpts);
    } catch (e) {
      part.newMiddle = `// INPRINT_FAILED because of exception:\n${e.message || "NO_ERROR_MESSAGE"}\\n${e.stack || "NO_STACK_TRACE"}`.split("\n").join("\n//     ");
    }
  }

  const newContent = fileHeader + inprint_prefix + parts.map(p => `${p.header}\n${p.newMiddle}\n${p.tail}`).join(inprint_prefix);
  writeFileSyncIfChanged(filePath, newContent);
  return true;
}

function callEmbeddedFeatures(params, options) {
  for (let embeddedFeature of _embeddedFeatures.embeddedFeatures) {
    const r = embeddedFeature.func(params, options);
    if (r) return r;
  }

  return undefined;
}

function doInprint(params, options) {
  if (options.embeddedFeatures === "first" || options.embeddedFeatures === true) {
    const r = callEmbeddedFeatures(params, options);
    if (r) return r;
  }

  if (options.inprint) {
    const r = options.inprint(params, options);
    if (r) return r;
  }

  if (options.embeddedFeatures === "last") {
    const r = callEmbeddedFeatures(params, options);
    if (r) return r;
  }

  return `// INPRINT_ERROR None of inprint functions returned a result. They all returned undefined!`;
} // const testFilePath = `D:\\b\\Mine\\GIT_Work\\yatasks_one_api\\src\\inprintTestFile.ts`;
// handleFile(testFilePath);


function run(options0) {
  if (process.argv[2] === "--version" || process.argv[2] === "-v") {
    // @ts-ignore
    console.log("1.0.19");
    return;
  }

  let optionsPath = undefined;
  if (process.argv[2]) try {
    if (!options0) {
      optionsPath = process.argv[2];
      options0 = require(optionsPath);
    }
  } catch (e) {
    console.error(`CODE00000000 INPRINT failed to load '${optionsPath}' because of exception:`);
    console.error(e);
    process.exit(1);
    return;
  }

  try {
    if (!options0) {
      optionsPath = (0, _path.resolve)(process.cwd(), "inprint.cjs");
      options0 = require(optionsPath);
    }
  } catch (e) {
    if (e.code !== "MODULE_NOT_FOUND") {
      console.error(`CODE00000000 INPRINT failed to load '${optionsPath}' because of exception:`);
      console.error(e);
      process.exit(1);
      return;
    }
  }

  try {
    if (!options0) {
      optionsPath = (0, _path.resolve)(process.cwd(), "inprint.js");
      options0 = require(optionsPath);
    }
  } catch (e) {
    if (e.code !== "MODULE_NOT_FOUND") {
      console.error(`CODE00000000 INPRINT failed to load '${optionsPath}' because of exception:`);
      console.error(e);
      process.exit(1);
      return;
    }
  }

  const options = _objectSpread(_objectSpread({}, _InprintOptions.defaultInprintOptions), options0);

  let processedCount = 0;

  (async () => {
    if (options.logging) console.log(`CODE00000005 INPRINT options from ${optionsPath}`);
    const paths = await (0, _globby.default)(options.files);

    for (let filePath of paths) {
      if (options.logging === "files") console.log(`CODE00000006 INPRINT ${filePath}`);
      if (filePath.includes("node_modules") && options.skipNodeModules) continue;
      if (handleFile(filePath, options)) processedCount++;
    }

    if (options.logging) console.log(`CODE00000007 INPRINT finished, ${paths.length} - total files, ${processedCount} - processed, ${paths.length - processedCount} - skipped`);
  })();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbnByaW50LnRzIl0sIm5hbWVzIjpbImlucHJpbnRfcHJlZml4Iiwic3RhcnRQcmVmaXgiLCJlbmRQcmVmaXgiLCJ1c2FnZU5vdGljZSIsIndyaXRlRmlsZVN5bmNJZkNoYW5nZWQiLCJmaWxlTmFtZSIsImNvbnRlbnQiLCJjdXJyZW50IiwiZSIsImhhbmRsZUZpbGUiLCJmaWxlUGF0aCIsIm9wdGlvbnMiLCJjb250ZW50U3RyIiwiaW5jbHVkZXMiLCJmaWxlSGVhZGVyIiwicGFydHMwIiwic3BsaXQiLCJwYXJ0cyIsImkiLCJsZW5ndGgiLCJzIiwic3RhcnRzV2l0aCIsImNvbnNvbGUiLCJlcnJvciIsImhlYWRlciIsIm1pZGRsZVBhcnRzIiwibGFzdFBhcnQiLCJwb3AiLCJwYXJhbXNTdHIiLCJzdWJzdHIiLCJ0cmltIiwibWlkZGxlIiwiam9pbiIsInRhaWwiLCJwYXJhbXMiLCJhYnNvbHV0ZVBhdGgiLCJKU09ONSIsInBhcnNlIiwicHVzaCIsIm5ld01pZGRsZSIsIm1lc3NhZ2UiLCJwYXJ0IiwiZG9JbnByaW50IiwicHJldHRpZXJPcHRzIiwic3RhY2siLCJuZXdDb250ZW50IiwibWFwIiwicCIsImNhbGxFbWJlZGRlZEZlYXR1cmVzIiwiZW1iZWRkZWRGZWF0dXJlIiwiZW1iZWRkZWRGZWF0dXJlcyIsInIiLCJmdW5jIiwidW5kZWZpbmVkIiwiaW5wcmludCIsInJ1biIsIm9wdGlvbnMwIiwicHJvY2VzcyIsImFyZ3YiLCJsb2ciLCJvcHRpb25zUGF0aCIsInJlcXVpcmUiLCJleGl0IiwiY3dkIiwiY29kZSIsImRlZmF1bHRJbnByaW50T3B0aW9ucyIsInByb2Nlc3NlZENvdW50IiwibG9nZ2luZyIsInBhdGhzIiwiZmlsZXMiLCJza2lwTm9kZU1vZHVsZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7QUFFTyxNQUFNQSxjQUFjLEdBQUcsTUFB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XCJnbG9iYnlcIjtcbmltcG9ydCB7IHJlYWRGaWxlU3luYywgd3JpdGVGaWxlU3luYyB9IGZyb20gXCJmc1wiO1xuaW1wb3J0IHsgcmVzb2x2ZSB9IGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBlbWJlZGRlZEZlYXR1cmVzIH0gZnJvbSBcIi4vZW1iZWRkZWRGZWF0dXJlc1wiO1xuaW1wb3J0IHsgZGVmYXVsdElucHJpbnRPcHRpb25zLCBJbnByaW50T3B0aW9ucyB9IGZyb20gXCIuL0lucHJpbnRPcHRpb25zXCI7XG5pbXBvcnQgeyBmb3JtYXRUeXBlc2NyaXB0IH0gZnJvbSBcIi4vZm9ybWF0VHlwZXNjcmlwdFwiO1xuXG5leHBvcnQgY29uc3QgaW5wcmludF9wcmVmaXggPSBcIkBcIiArIFwiSU5QUklOVFwiO1xuZXhwb3J0IGNvbnN0IHN0YXJ0UHJlZml4ID0gXCJfU1RBUlRcIjtcbmV4cG9ydCBjb25zdCBlbmRQcmVmaXggPSBcIl9FTkRcIjtcbmV4cG9ydCBjb25zdCB1c2FnZU5vdGljZSA9IGBcblVTQUdFOlxuXG4vLyAke2lucHJpbnRfcHJlZml4fV9TVEFSVCB7Li4uYW55X2pzb25fcGFyYW1zLi4ufVxuLy8gR2VuZXJhdGVkIGNvZGUgd2lsbCBnbyBoZXJlXG4vLyAke2lucHJpbnRfcHJlZml4fV9FTkRcbmA7XG5cbmludGVyZmFjZSBJbnByaW50RmlsZVBhcnQge1xuICAgIGhlYWRlcjogc3RyaW5nO1xuICAgIHBhcmFtczogYW55O1xuICAgIG1pZGRsZTogc3RyaW5nO1xuICAgIHRhaWw6IHN0cmluZztcbiAgICBuZXdNaWRkbGU6IHN0cmluZztcbn1cblxuZXhwb3J0IGNvbnN0IHdyaXRlRmlsZVN5bmNJZkNoYW5nZWQgPSAoZmlsZU5hbWU6IHN0cmluZywgY29udGVudDogc3RyaW5nKSA9PiB7XG4gICAgbGV0IGN1cnJlbnQ6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICB0cnkge1xuICAgICAgICBjdXJyZW50ID0gcmVhZEZpbGVTeW5jKGZpbGVOYW1lLCBcInV0Zi04XCIpO1xuICAgIH0gY2F0Y2ggKGUpIHt9XG5cbiAgICBpZiAoY3VycmVudCAhPT0gY29udGVudCkge1xuICAgICAgICB3cml0ZUZpbGVTeW5jKGZpbGVOYW1lLCBjb250ZW50LCBcInV0Zi04XCIpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGhhbmRsZUZpbGUoZmlsZVBhdGg6IHN0cmluZywgb3B0aW9uczogSW5wcmludE9wdGlvbnMpOiBib29sZWFuIHtcbiAgICBjb25zdCBjb250ZW50U3RyID0gcmVhZEZpbGVTeW5jKGZpbGVQYXRoLCBcInV0Zi04XCIpO1xuXG4gICAgaWYgKCFjb250ZW50U3RyLmluY2x1ZGVzKGlucHJpbnRfcHJlZml4KSkgcmV0dXJuIGZhbHNlO1xuXG4gICAgY29uc3QgW2ZpbGVIZWFkZXIsIC4uLnBhcnRzMF0gPSBjb250ZW50U3RyLnNwbGl0KGlucHJpbnRfcHJlZml4KTtcbiAgICBjb25zdCBwYXJ0czogSW5wcmludEZpbGVQYXJ0W10gPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcnRzMC5sZW5ndGg7IGkgKz0gMikge1xuICAgICAgICBjb25zdCBzID0gcGFydHMwW2ldO1xuICAgICAgICBpZiAoIXMuc3RhcnRzV2l0aChzdGFydFByZWZpeCkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYENPREUwMDAwMDAwMSBJTlBSSU5UX0VSUk9SIE5vICR7aW5wcmludF9wcmVmaXh9JHtzdGFydFByZWZpeH0gaW4gJHtmaWxlUGF0aH1gKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghcGFydHMwW2kgKyAxXS5zdGFydHNXaXRoKGVuZFByZWZpeCkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYENPREUwMDAwMDAwMiBJTlBSSU5UX0VSUk9SIE5vICR7aW5wcmludF9wcmVmaXh9JHtlbmRQcmVmaXh9IGluICR7ZmlsZVBhdGh9YCk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgW2hlYWRlciwgLi4ubWlkZGxlUGFydHNdID0gcy5zcGxpdChcIlxcblwiKTtcbiAgICAgICAgICAgIGNvbnN0IGxhc3RQYXJ0ID0gbWlkZGxlUGFydHMucG9wKCk7XG5cbiAgICAgICAgICAgIGNvbnN0IHBhcmFtc1N0ciA9IGhlYWRlci5zdWJzdHIoc3RhcnRQcmVmaXgubGVuZ3RoKS50cmltKCk7XG4gICAgICAgICAgICBjb25zdCBtaWRkbGUgPSBtaWRkbGVQYXJ0cy5qb2luKFwiXFxuXCIpO1xuICAgICAgICAgICAgY29uc3QgdGFpbCA9IGxhc3RQYXJ0ICsgaW5wcmludF9wcmVmaXggKyBwYXJ0czBbaSArIDFdO1xuXG4gICAgICAgICAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICAgICAgICAgICAgY29udGVudDogbWlkZGxlLFxuICAgICAgICAgICAgICAgIGFic29sdXRlUGF0aDogZmlsZVBhdGgsXG4gICAgICAgICAgICAgICAgLi4uSlNPTjUucGFyc2UocGFyYW1zU3RyKSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYXJ0cy5wdXNoKHsgaGVhZGVyLCBwYXJhbXMsIG1pZGRsZSwgdGFpbCwgbmV3TWlkZGxlOiBcIlwiIH0pO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBDT0RFMDAwMDAwMDMgSU5QUklOVF9FUlJPUiAke2UubWVzc2FnZX0gaW4gJHtmaWxlUGF0aH1gKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGZvciAobGV0IHBhcnQgb2YgcGFydHMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHBhcnQubmV3TWlkZGxlID0gZm9ybWF0VHlwZXNjcmlwdChkb0lucHJpbnQocGFydC5wYXJhbXMsIG9wdGlvbnMpLCBvcHRpb25zLnByZXR0aWVyT3B0cyk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHBhcnQubmV3TWlkZGxlID0gYC8vIElOUFJJTlRfRkFJTEVEIGJlY2F1c2Ugb2YgZXhjZXB0aW9uOlxcbiR7ZS5tZXNzYWdlIHx8IFwiTk9fRVJST1JfTUVTU0FHRVwifVxcXFxuJHtcbiAgICAgICAgICAgICAgICBlLnN0YWNrIHx8IFwiTk9fU1RBQ0tfVFJBQ0VcIlxuICAgICAgICAgICAgfWBcbiAgICAgICAgICAgICAgICAuc3BsaXQoXCJcXG5cIilcbiAgICAgICAgICAgICAgICAuam9pbihcIlxcbi8vICAgICBcIik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBuZXdDb250ZW50ID1cbiAgICAgICAgZmlsZUhlYWRlciArIGlucHJpbnRfcHJlZml4ICsgcGFydHMubWFwKChwKSA9PiBgJHtwLmhlYWRlcn1cXG4ke3AubmV3TWlkZGxlfVxcbiR7cC50YWlsfWApLmpvaW4oaW5wcmludF9wcmVmaXgpO1xuICAgIHdyaXRlRmlsZVN5bmNJZkNoYW5nZWQoZmlsZVBhdGgsIG5ld0NvbnRlbnQpO1xuICAgIHJldHVybiB0cnVlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2FsbEVtYmVkZGVkRmVhdHVyZXMocGFyYW1zOiBhbnksIG9wdGlvbnM6IElucHJpbnRPcHRpb25zKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBmb3IgKGxldCBlbWJlZGRlZEZlYXR1cmUgb2YgZW1iZWRkZWRGZWF0dXJlcykge1xuICAgICAgICBjb25zdCByID0gZW1iZWRkZWRGZWF0dXJlLmZ1bmMocGFyYW1zLCBvcHRpb25zKTtcbiAgICAgICAgaWYgKHIpIHJldHVybiByO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZG9JbnByaW50KHBhcmFtczogYW55LCBvcHRpb25zOiBJbnByaW50T3B0aW9ucyk6IHN0cmluZyB7XG4gICAgaWYgKG9wdGlvbnMuZW1iZWRkZWRGZWF0dXJlcyA9PT0gXCJmaXJzdFwiIHx8IG9wdGlvbnMuZW1iZWRkZWRGZWF0dXJlcyA9PT0gdHJ1ZSkge1xuICAgICAgICBjb25zdCByID0gY2FsbEVtYmVkZGVkRmVhdHVyZXMocGFyYW1zLCBvcHRpb25zKTtcbiAgICAgICAgaWYgKHIpIHJldHVybiByO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLmlucHJpbnQpIHtcbiAgICAgICAgY29uc3QgciA9IG9wdGlvbnMuaW5wcmludChwYXJhbXMsIG9wdGlvbnMpO1xuICAgICAgICBpZiAocikgcmV0dXJuIHI7XG4gICAgfVxuXG4gICAgaWYgKG9wdGlvbnMuZW1iZWRkZWRGZWF0dXJlcyA9PT0gXCJsYXN0XCIpIHtcbiAgICAgICAgY29uc3QgciA9IGNhbGxFbWJlZGRlZEZlYXR1cmVzKHBhcmFtcywgb3B0aW9ucyk7XG4gICAgICAgIGlmIChyKSByZXR1cm4gcjtcbiAgICB9XG4gICAgcmV0dXJuIGAvLyBJTlBSSU5UX0VSUk9SIE5vbmUgb2YgaW5wcmludCBmdW5jdGlvbnMgcmV0dXJuZWQgYSByZXN1bHQuIFRoZXkgYWxsIHJldHVybmVkIHVuZGVmaW5lZCFgO1xufVxuXG4vLyBjb25zdCB0ZXN0RmlsZVBhdGggPSBgRDpcXFxcYlxcXFxNaW5lXFxcXEdJVF9Xb3JrXFxcXHlhdGFza3Nfb25lX2FwaVxcXFxzcmNcXFxcaW5wcmludFRlc3RGaWxlLnRzYDtcbi8vIGhhbmRsZUZpbGUodGVzdEZpbGVQYXRoKTtcblxuZXhwb3J0IGZ1bmN0aW9uIHJ1bihvcHRpb25zMD86IElucHJpbnRPcHRpb25zIHwgdW5kZWZpbmVkKSB7XG4gICAgaWYgKHByb2Nlc3MuYXJndlsyXSA9PT0gXCItLXZlcnNpb25cIiB8fCBwcm9jZXNzLmFyZ3ZbMl0gPT09IFwiLXZcIikge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbnNvbGUubG9nKF9fVkVSU0lPTl9fKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBvcHRpb25zUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuICAgIGlmIChwcm9jZXNzLmFyZ3ZbMl0pXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoIW9wdGlvbnMwKSB7XG4gICAgICAgICAgICAgICAgb3B0aW9uc1BhdGggPSBwcm9jZXNzLmFyZ3ZbMl07XG4gICAgICAgICAgICAgICAgb3B0aW9uczAgPSByZXF1aXJlKG9wdGlvbnNQYXRoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgQ09ERTAwMDAwMDAwIElOUFJJTlQgZmFpbGVkIHRvIGxvYWQgJyR7b3B0aW9uc1BhdGh9JyBiZWNhdXNlIG9mIGV4Y2VwdGlvbjpgKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAgIGlmICghb3B0aW9uczApIHtcbiAgICAgICAgICAgIG9wdGlvbnNQYXRoID0gcmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBcImlucHJpbnQuY2pzXCIpO1xuICAgICAgICAgICAgb3B0aW9uczAgPSByZXF1aXJlKG9wdGlvbnNQYXRoKTtcbiAgICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKGUuY29kZSAhPT0gXCJNT0RVTEVfTk9UX0ZPVU5EXCIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYENPREUwMDAwMDAwMCBJTlBSSU5UIGZhaWxlZCB0byBsb2FkICcke29wdGlvbnNQYXRofScgYmVjYXVzZSBvZiBleGNlcHRpb246YCk7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgICAgaWYgKCFvcHRpb25zMCkge1xuICAgICAgICAgICAgb3B0aW9uc1BhdGggPSByZXNvbHZlKHByb2Nlc3MuY3dkKCksIFwiaW5wcmludC5qc1wiKTtcbiAgICAgICAgICAgIG9wdGlvbnMwID0gcmVxdWlyZShvcHRpb25zUGF0aCk7XG4gICAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGlmIChlLmNvZGUgIT09IFwiTU9EVUxFX05PVF9GT1VORFwiKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBDT0RFMDAwMDAwMDAgSU5QUklOVCBmYWlsZWQgdG8gbG9hZCAnJHtvcHRpb25zUGF0aH0nIGJlY2F1c2Ugb2YgZXhjZXB0aW9uOmApO1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IG9wdGlvbnM6IElucHJpbnRPcHRpb25zID0geyAuLi5kZWZhdWx0SW5wcmludE9wdGlvbnMsIC4uLm9wdGlvbnMwIH07XG4gICAgbGV0IHByb2Nlc3NlZENvdW50ID0gMDtcbiAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICBpZiAob3B0aW9ucy5sb2dnaW5nKSBjb25zb2xlLmxvZyhgQ09ERTAwMDAwMDA1IElOUFJJTlQgb3B0aW9ucyBmcm9tICR7b3B0aW9uc1BhdGh9YCk7XG4gICAgICAgIGNvbnN0IHBhdGhzID0gYXdhaXQgZ2xvYmJ5KG9wdGlvbnMuZmlsZXMpO1xuXG4gICAgICAgIGZvciAobGV0IGZpbGVQYXRoIG9mIHBhdGhzKSB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5sb2dnaW5nID09PSBcImZpbGVzXCIpIGNvbnNvbGUubG9nKGBDT0RFMDAwMDAwMDYgSU5QUklOVCAke2ZpbGVQYXRofWApO1xuICAgICAgICAgICAgaWYgKGZpbGVQYXRoLmluY2x1ZGVzKFwibm9kZV9tb2R1bGVzXCIpICYmIG9wdGlvbnMuc2tpcE5vZGVNb2R1bGVzKSBjb250aW51ZTtcbiAgICAgICAgICAgIGlmIChoYW5kbGVGaWxlKGZpbGVQYXRoLCBvcHRpb25zKSkgcHJvY2Vzc2VkQ291bnQrKztcbiAgICAgICAgfVxuICAgICAgICBpZiAob3B0aW9ucy5sb2dnaW5nKVxuICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgICAgYENPREUwMDAwMDAwNyBJTlBSSU5UIGZpbmlzaGVkLCAke3BhdGhzLmxlbmd0aH0gLSB0b3RhbCBmaWxlcywgJHtwcm9jZXNzZWRDb3VudH0gLSBwcm9jZXNzZWQsICR7XG4gICAgICAgICAgICAgICAgICAgIHBhdGhzLmxlbmd0aCAtIHByb2Nlc3NlZENvdW50XG4gICAgICAgICAgICAgICAgfSAtIHNraXBwZWRgXG4gICAgICAgICAgICApO1xuICAgIH0pKCk7XG59XG4iXX0=